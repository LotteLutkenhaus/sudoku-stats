# Sudoku Stats Tracker

A serverless application that automatically tracks and stores completion statistics for the Sudoku puzzle in the New York Times games app. 

Results are stored in a database, and displayed in Grafana. My personal dashboard can be found [here](https://sudokutracker.grafana.net/public-dashboards/021f11e0932e4ed6b98887bf008fc8de). 

## Architecture Overview

This application processes screenshots of completed NYT Sudoku puzzles through the following workflow:
1. Screenshots are uploaded to Google Drive (uploading this is a manual step. Preferably they are retrieved from Google Photos directly, but the scopes needed for that were removed from the API early 2025.)
2. A webhook triggers the Cloud Run service (I'm using Make (free tier) which triggers whenever a new screenshot is uploaded in a specific folder.)
3. Claude AI extracts difficulty level and completion time from the screenshot
4. Results are stored in a PostgreSQL database (hosted via Neon)

## Tech Stack

- **Runtime**: Python 3.12 with Functions Framework
- **Deployment**: Google Cloud Run (containerized with Docker)
- **AI/ML**: Claude 3.5 Haiku for image processing
- **Database**: PostgreSQL (Neon hosted)
- **Storage**: Google Drive API for screenshot retrieval
- **Authentication**: Google Secret Manager for credentials

## Deployment to Google Cloud Run

The application is configured for continuous deployment from GitHub to Google Cloud Run.

### Initial Setup

Follow the [Google Cloud Run continuous deployment guide](https://cloud.google.com/run/docs/quickstarts/deploy-continuously).

### Configuration Deviations

#### Cloud Build
- Uses a custom Dockerfile instead of Google buildpacks
- The Dockerfile specifies the Functions Framework entry point

#### Authentication
- Allow unauthenticated invocations. 

#### Container Settings
- **Port**: 8080
- **Command**: Leave blank (uses Dockerfile CMD)
- **Arguments**: Leave blank

#### Request Configuration
- **Timeout**: 3000 seconds (adjust as needed)

#### Security
- **Service Account**: Select your designated service account with appropriate permissions (at least secret manager accessor)

#### Environment Variables
- None needed

## Database

The application uses PostgreSQL hosted on Neon for data storage. The schema includes:
- Puzzle completion timestamps
- Solving duration (stored as PostgreSQL interval)
- Difficulty levels (easy, medium, hard)
- Auto-generated IDs and creation timestamps

## Webhooks

I personally use [Make](https://www.make.com/en) to watch the Google Drive folder that I store my
Sudoku screenshots in. When it finds a new screenshot, it fires a webhook to the Google Cloud Run
address. When setting up the webhook, make sure to add a 'X-API-Key' header for authentication.

## Required Secrets in Google Secret Manager

The following secrets need to be configured in Google Secret Manager for the application to function:

| Secret Name | Description | Format                                                                  |
|------------|-------------|-------------------------------------------------------------------------|
| `claude-api-key` | Anthropic Claude API key for image analysis | String (API key from Anthropic console)                                 |
| `make-api-key` | Authentication token for webhook requests | String (custom token you generate)                                      |
| `google-drive-token` | OAuth2 token for Google Drive API access | JSON (generated by authentication script, see below)                    |
| `neon-database-connection-string` | PostgreSQL connection URL for Neon database | PostgreSQL URL format: `postgresql://user:pass@host/db?sslmode=require` |

## Local Development

### Prerequisites
```bash
# Authenticate with Google Cloud
gcloud auth application-default login

# Set up environment variables
export DATABASE_URL_DEV="your-neon-connection-string"
```

### Running Locally
```bash
# Install dependencies
pip install -r requirements.txt

# Run with Functions Framework
functions-framework --target=process_sudoku_screenshot --debug
```

### Environment Configuration
For IDE debugging, configure your run environment to include:
- Script path to `main.py`
- Environment variables from `.env` file (use EnvFile plugin if available)
- Google Cloud credentials path 

## Google API Authentication

### Setting up OAuth 2.0 Credentials

To authenticate with Google services (Drive for this app, but also Calendar, Gmail, etc.), follow 
these steps:

1. **Configure OAuth 2.0 Client**
   - Navigate to [Google Cloud Console - Credentials](https://console.cloud.google.com/apis/credentials)
   - Create a new OAuth 2.0 Client ID
   - Set application type to "Web application"
   - Add redirect URI: `http://localhost:8080/`
   - Set publishing status to "In Production" to prevent token expiration

2. **Generate and Store Credentials**
   - Download the client secret JSON file
   - Rename it to `credentials.json`
   - Run the authentication script below to generate `token.json`
   - Upload `token.json` to Google Secret Manager

### Generating the Token

Use the provided authentication script to generate the OAuth2 token:

```bash
# Place your credentials.json file in the scripts directory
cd scripts

# Run the authentication script
python generate_google_token.py
```

The script will:
1. Look for `credentials.json` in the current directory
2. Open a browser window for Google authentication
3. Generate a `token.json` file after successful login
4. Display instructions for uploading to Google Secret Manager